name: CI

on:
  push:
    branches: [master, main, develop]
  pull_request:
    branches: [master, main, develop]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  POSTGRES_USER: hazop
  POSTGRES_PASSWORD: testpassword
  POSTGRES_DB: hazop_test

jobs:
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check formatting
        run: npm run format:check

      - name: Lint
        run: npm run lint

  typecheck:
    name: TypeScript Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: TypeScript check
        run: npm run typecheck

  test-api:
    name: API Unit Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run database migrations
        run: |
          for file in migrations/*.sql; do
            PGPASSWORD=${{ env.POSTGRES_PASSWORD }} psql -h localhost -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} -f "$file"
          done

      - name: Run API tests
        run: cd apps/api && npm test
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://${{ env.POSTGRES_USER }}:${{ env.POSTGRES_PASSWORD }}@localhost:5432/${{ env.POSTGRES_DB }}
          REDIS_URL: redis://localhost:6379
          JWT_PRIVATE_KEY: |
            -----BEGIN RSA PRIVATE KEY-----
            MIIEpAIBAAKCAQEA2Z3qX2BTLS4e0NobNVxzMJCGOqQJzIVh3G7TfaWwEAb5mPUK
            v5MYP8cpJN7G2UvEg5VZJj0MsS6vjYNY9NM3Gic+fKN1fqJGVkYa2JPTIB4V3Q+2
            TnXj7BH0s8LwQZQQ+fkT8x1XF0pLF+8Q++VZcOELh+3fkSN6Y3WCENaJv/H8E1dL
            s5m1V7Ey3w6m5l+SJc8vK0mTw0I75k9r1Y3H8Nz9r3t3FQdKT0aw3HgMZ8JDKIC3
            h0RUm4lgJ0MZX0UDdB/5ZQw+Y1pVVaGHsXXC/BKw6NVJ7v1+P9B1VxdXm1+Xrqoi
            x1WJNQNTv3W/fjF1fOlVw3D3EZ5bOyf7ELTtFwIDAQABAoIBAC4P6nBLmST+C/Kz
            k3l2y2XGK8kZmFLG8dW4GjYPfZq7xVL2+jLHd0f7UYOoJy5IaVYXG8R7mYiDHKfD
            m2FwB6VHuN9Br0WrHVJQQMpW4GjEKLPfU8V3wvNL9gQGypQ7q1mQ1rxC5HbBzpqK
            4GBSfJlFLwHwCW7qGHyoVj7E5fGJK8vdVLW5h8R5y8jEq8P7iFZ0zhb+L1lslN5J
            f8GPXG/E8TrqjYNGpVmx9oN3F0gDEm7v+oeJEGU9l1q0xY3qV3j7t8z3QKjvA7Hp
            rU3lG8EY5S8vUvN3Q7EFwvUPaL0m8lP0vXa7bHL3m8v5q7Q2D3lF5jM6Y0uA4xS9
            Q7X0r4ECgYEA7lz5Rk0p0VJMQnZG4cK8NQrBmMvv/WNQZ3FqNB1N1F1L7u5KZVHW
            6Q5V3Z5NnVN3k7E8R2xH3jH8kzV8K5N9Z3l5P3D5E8Q9Q3D5E8Q9Q3D5E8Q9Q3D5
            E8Q9Q3D5E8Q9Q3D5E8Q9Q3D5E8Q9Q3D5E8Q9Q3D5E8Q9Q3D5E8Q9Q3cCgYEA6XH5
            -----END RSA PRIVATE KEY-----
          JWT_PUBLIC_KEY: |
            -----BEGIN PUBLIC KEY-----
            MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA2Z3qX2BTLS4e0NobNVxz
            MJCGO qQJzIVh3G7TfaWwEAb5mPUKv5MYP8cpJN7G2UvEg5VZJj0MsS6vjYNY9NM3
            Gic+fKN1fqJGVkYa2JPTIB4V3Q+2TnXj7BH0s8LwQZQQ+fkT8x1XF0pLF+8Q++VZ
            cOELh+3fkSN6Y3WCENaJv/H8E1dLs5m1V7Ey3w6m5l+SJc8vK0mTw0I75k9r1Y3H
            8Nz9r3t3FQdKT0aw3HgMZ8JDKIC3h0RUm4lgJ0MZX0UDdB/5ZQw+Y1pVVaGHsXXC
            /BKw6NVJ7v1+P9B1VxdXm1+Xrqoix1WJNQNTv3W/fjF1fOlVw3D3EZ5bOyf7ELTt
            FwIDAQAB
            -----END PUBLIC KEY-----

  test-web:
    name: Web Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Web tests
        run: cd apps/web && npm test

  test-e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
      minio:
        image: minio/minio:latest
        env:
          MINIO_ROOT_USER: minioadmin
          MINIO_ROOT_PASSWORD: minioadmin
        ports:
          - 9000:9000
        options: >-
          --health-cmd "curl -f http://localhost:9000/minio/health/live"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        # Note: minio service command is specified differently
      rabbitmq:
        image: rabbitmq:3-management
        env:
          RABBITMQ_DEFAULT_USER: hazop
          RABBITMQ_DEFAULT_PASS: testpassword
        ports:
          - 5672:5672
          - 15672:15672
        options: >-
          --health-cmd "rabbitmq-diagnostics -q ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run database migrations
        run: |
          for file in migrations/*.sql; do
            PGPASSWORD=${{ env.POSTGRES_PASSWORD }} psql -h localhost -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} -f "$file"
          done

      - name: Start API server
        run: |
          cd apps/api && npm run build
          cd apps/api && npm start &
          sleep 5
        env:
          NODE_ENV: test
          PORT: 4000
          DATABASE_URL: postgresql://${{ env.POSTGRES_USER }}:${{ env.POSTGRES_PASSWORD }}@localhost:5432/${{ env.POSTGRES_DB }}
          REDIS_URL: redis://localhost:6379
          MINIO_ENDPOINT: localhost
          MINIO_PORT: 9000
          MINIO_ACCESS_KEY: minioadmin
          MINIO_SECRET_KEY: minioadmin
          MINIO_USE_SSL: false
          RABBITMQ_URL: amqp://hazop:testpassword@localhost:5672
          JWT_PRIVATE_KEY: |
            -----BEGIN RSA PRIVATE KEY-----
            MIIEpAIBAAKCAQEA2Z3qX2BTLS4e0NobNVxzMJCGOqQJzIVh3G7TfaWwEAb5mPUK
            v5MYP8cpJN7G2UvEg5VZJj0MsS6vjYNY9NM3Gic+fKN1fqJGVkYa2JPTIB4V3Q+2
            TnXj7BH0s8LwQZQQ+fkT8x1XF0pLF+8Q++VZcOELh+3fkSN6Y3WCENaJv/H8E1dL
            s5m1V7Ey3w6m5l+SJc8vK0mTw0I75k9r1Y3H8Nz9r3t3FQdKT0aw3HgMZ8JDKIC3
            h0RUm4lgJ0MZX0UDdB/5ZQw+Y1pVVaGHsXXC/BKw6NVJ7v1+P9B1VxdXm1+Xrqoi
            x1WJNQNTv3W/fjF1fOlVw3D3EZ5bOyf7ELTtFwIDAQABAoIBAC4P6nBLmST+C/Kz
            k3l2y2XGK8kZmFLG8dW4GjYPfZq7xVL2+jLHd0f7UYOoJy5IaVYXG8R7mYiDHKfD
            m2FwB6VHuN9Br0WrHVJQQMpW4GjEKLPfU8V3wvNL9gQGypQ7q1mQ1rxC5HbBzpqK
            4GBSfJlFLwHwCW7qGHyoVj7E5fGJK8vdVLW5h8R5y8jEq8P7iFZ0zhb+L1lslN5J
            f8GPXG/E8TrqjYNGpVmx9oN3F0gDEm7v+oeJEGU9l1q0xY3qV3j7t8z3QKjvA7Hp
            rU3lG8EY5S8vUvN3Q7EFwvUPaL0m8lP0vXa7bHL3m8v5q7Q2D3lF5jM6Y0uA4xS9
            Q7X0r4ECgYEA7lz5Rk0p0VJMQnZG4cK8NQrBmMvv/WNQZ3FqNB1N1F1L7u5KZVHW
            6Q5V3Z5NnVN3k7E8R2xH3jH8kzV8K5N9Z3l5P3D5E8Q9Q3D5E8Q9Q3D5E8Q9Q3D5
            E8Q9Q3D5E8Q9Q3D5E8Q9Q3D5E8Q9Q3D5E8Q9Q3D5E8Q9Q3D5E8Q9Q3cCgYEA6XH5
            -----END RSA PRIVATE KEY-----
          JWT_PUBLIC_KEY: |
            -----BEGIN PUBLIC KEY-----
            MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA2Z3qX2BTLS4e0NobNVxz
            MJCGO qQJzIVh3G7TfaWwEAb5mPUKv5MYP8cpJN7G2UvEg5VZJj0MsS6vjYNY9NM3
            Gic+fKN1fqJGVkYa2JPTIB4V3Q+2TnXj7BH0s8LwQZQQ+fkT8x1XF0pLF+8Q++VZ
            cOELh+3fkSN6Y3WCENaJv/H8E1dLs5m1V7Ey3w6m5l+SJc8vK0mTw0I75k9r1Y3H
            8Nz9r3t3FQdKT0aw3HgMZ8JDKIC3h0RUm4lgJ0MZX0UDdB/5ZQw+Y1pVVaGHsXXC
            /BKw6NVJ7v1+P9B1VxdXm1+Xrqoix1WJNQNTv3W/fjF1fOlVw3D3EZ5bOyf7ELTt
            FwIDAQAB
            -----END PUBLIC KEY-----

      - name: Build frontend
        run: cd apps/web && npm run build
        env:
          VITE_API_URL: http://localhost:4000

      - name: Serve frontend
        run: |
          npx serve -s apps/web/dist -l 3000 &
          sleep 3

      - name: Run E2E tests
        run: npm run test:e2e
        env:
          BASE_URL: http://localhost:3000
          API_URL: http://localhost:4000

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test-api, test-web]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build API image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: apps/api/Dockerfile
          push: false
          tags: hazop-api:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Web image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: apps/web/Dockerfile
          push: false
          tags: hazop-web:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
